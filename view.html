<!doctype html>
<html lang="en">

<!-- #region Boilerplate -->

<head>
  <meta charset="utf-8">
  <title>Coin View</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootswatch/4.4.1/darkly/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.10.20/css/dataTables.bootstrap4.min.css">

  <!-- #endregion -->

  <!-- #region CSS -->

  <style>
    input,
    a {
      outline: none !important;
      box-shadow: none !important;
    }

    nav {
      font-weight: bold;
      margin-top: 20px;
      margin-bottom: 20px;
    }

    nav .nav-link.active {
      background-color: #009670 !important;
    }

    .tab-pane {
      padding: 20px;
    }

    table.dataTable {
      width: 100%;
    }

    table.dataTable tr {
      line-height: 24px;
    }

    td {
      vertical-align: middle !important;
    }

    table.dataTable tbody tr.odd {
      background-color: #303030;
    }

    table.dataTable tbody tr:hover {
      background-color: #505050;
    }

    table.dataTable tbody td.type-in,
    table.dataTable tbody td.audited {
      background-color: #009670;
    }

    table.dataTable tbody td.type-tr {
      background-color: #D98D14;
    }

    table td.right,
    table th.right {
      text-align: right;
      padding-right: 10px;
    }

    table tbody td.center {
      text-align: center;
    }

    table.dataTable tfoot td input {
      width: 100%;
    }

    ul.pagination {
      float: right;
    }

    #tx-pos {
      float: left;
    }

    #tx-sum {
      text-align: center;
      font-size: large;
    }

    #tx-sum-diff {
      font-size: larger;
      font-weight: bold;
    }

    .tx-bottom-text {
      line-height: 34px;
    }

    #acc-table {
      width: auto;
      font-size: x-large;
      margin: 30px auto 0 auto;
    }

    #acc-table td,
    #acc-table th {
      padding: 0 30px;
    }

    #acc-date {
      display: block;
      margin: 20px auto 50px auto;
      width: 200px;
      text-align: center;
      font-size: x-large;
      border: 4px solid transparent;
    }

    #acc-date.invalid {
      border-color: #E74C3C;
    }
  </style>


</head>

<!-- #endregion -->

<!-- #region HTML -->

<body>

  <nav>
    <div class="nav nav-pills justify-content-center" id="nav-tab" role="tablist">
      <a class="nav-item nav-link active" id="nav-overview-tab" data-toggle="tab" href="#nav-overview" role="tab"
        aria-controls="nav-overview" aria-selected="true">Overview</a>
      <a class="nav-item nav-link" id="nav-categories-tab" data-toggle="tab" href="#nav-categories" role="tab"
        aria-controls="nav-categories" aria-selected="false">Categories</a>
      <a class="nav-item nav-link" id="nav-accounts-tab" data-toggle="tab" href="#nav-accounts" role="tab"
        aria-controls="nav-accounts" aria-selected="false">Accounts</a>
      <a class="nav-item nav-link" id="nav-transactions-tab" data-toggle="tab" href="#nav-transactions" role="tab"
        aria-controls="nav-transactions" aria-selected="false">Transactions</a>
    </div>
  </nav>

  <div class="tab-content" id="nav-tabContent">
    <div class="tab-pane active" id="nav-overview" role="tabpanel" aria-labelledby="nav-overview-tab">
      Overview
    </div>

    <div class="tab-pane" id="nav-categories" role="tabpanel" aria-labelledby="nav-categories-tab">
      <table id="cat-table" class="table">
        <thead>
          <tr>
            <th>Category</th>
            <th>Subcategory</th>
            <th>Jan</th>
            <th>Feb</th>
            <th>Mar</th>
            <th>Apr</th>
            <th>May</th>
            <th>Jun</th>
            <th>Jul</th>
            <th>Aug</th>
            <th>Sep</th>
            <th>Oct</th>
            <th>Nov</th>
            <th>Dec</th>
            <th>Sum</th>
            <th>Avg</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="tab-pane" id="nav-accounts" role="tabpanel" aria-labelledby="nav-accounts-tab">
      <input type="text" id="acc-date" placeholder="Today" />
      <table id="acc-table" class="table">
        <thead>
          <tr>
            <th>Group</th>
            <th>Account</th>
            <th>Currency</th>
            <th>Balance</th>
            <th>Converted</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <th>Sum:</th>
          <th></th>
          <th></th>
          <th></th>
          <th id="account-sum-total" class="right"></th>
        </tfoot>
      </table>
    </div>

    <div class="tab-pane" id="nav-transactions" role="tabpanel" aria-labelledby="nav-transactions-tab">
      <table id="tx-table">
        <thead>
          <tr>
            <th class="date">Date</th>
            <th class="basic">Mark</th>
            <th class="basic">Comment</th>
            <th class="basic">Type</th>
            <th class="range">From Amount</th>
            <th class="basic">From Account</th>
            <th class="range">To Amount</th>
            <th class="basic">To Account</th>
            <th class="basic">Category</th>
            <th class="basic">Subcategory</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
        </tfoot>
      </table>
      <div id="tx-pos" class="tx-bottom-text"></div>
      <div id="tx-sum" class="tx-bottom-text">
        <span id="tx-sum-i"></span> -
        <span id="tx-sum-e"></span> =
        <span id="tx-sum-diff"></span>
      </div>
    </div>
  </div>

  <!-- #endregion -->

  <!-- #region Script Includes -->

  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
    integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
    crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
    integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
    crossorigin="anonymous"></script>
  <script src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.10.20/js/dataTables.bootstrap4.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"
    integrity="sha256-4iQZ6BVL4qNKlQ27TExEhBN1HFPvAvAMbFavKKosSWQ=" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/hotkeys-js/dist/hotkeys.min.js"></script>

  <!-- #endregion -->

  <script>

    // #region Currency Exchange

    data = INSERT_DATA_HERE
    default_currency = data.currency
    display_currency = data.display_currency || default_currency

    // const exchange = await (async () => {
    //   const base = display_currency
    //   const currs = new Set()
    //   for (const [, acc] of Object.entries(data.accounts)) {
    //     if (acc.currency) {
    //       currs.add(acc.currency)
    //     }
    //   }
    //   const symbols = [...currs].join(',')
    //   const api = `https://api.exchangeratesapi.io/latest?base=${base}&symbols=${symbols}`
    //   return await $.getJSON(api)
    // })()

    // use this actual response temporarily until development/testing is done
    exchange = { "rates": { "EUR": 0.0030158634, "USD": 0.0033400688, "GBP": 0.0025392062 }, "base": "HUF", "date": "2019-12-09" }
    exchange.calculate = (amount, from, to) => {
      if (from != exchange.base) {
        amount /= exchange.rates[from]
      }
      if (to != exchange.base) {
        amount *= exchange.rates[to]
      }
      return amount
    }

    // #endregion

    // #region Data Prep

    // some basic defaults
    for (const tx of data.transactions) {

      if (tx.from) {
        tx.from.converted = exchange.calculate(
          tx.from.amount,
          data.accounts[tx.from.account.id].currency || default_currency,
          display_currency
        )
        tx.from.str = tx.from.amount
      } else {
        tx.from = { converted: 0, amount: '', account: { display: '' } }
      }

      if (tx.to) {
        tx.to.converted = exchange.calculate(
          tx.to.amount,
          data.accounts[tx.to.account.id].currency || default_currency,
          display_currency
        )
        tx.to.str = tx.to.amount
      } else {
        tx.to = { converted: 0, amount: '', account: { display: '' } }
      }

      tx.category = tx.category || { main: { display: '' }, sub: { display: '' } }
    }

    // category sums (both month-based and global)
    data.category_sums = {}
    for (const tx of data.transactions) {
      if (tx.type != 'TR') {
        const month = moment(tx.date).month()
        const dir = tx.type.toLowerCase()
        const main = tx.category.main.id
        const sub = tx.category.sub.id
        const amount = tx.type == 'EX' ? tx.from.converted : tx.to.converted
        const c = data.category_sums

        c.month = c.month || {}
        c.month[month] = c.month[month] || {}
        c.month[month][dir] = c.month[month][dir] || { sum: 0 }
        c.month[month][dir][main] = c.month[month][dir][main] || { sum: 0 }
        c.month[month][dir][main][sub] = c.month[month][dir][main][sub] || 0
        c.month[month][dir].sum += amount
        c.month[month][dir][main].sum += amount
        c.month[month][dir][main][sub] += amount

        c.global = c.global || {}
        c.global[dir] = c.global[dir] || { sum: 0 }
        c.global[dir][main] = c.global[dir][main] || { sum: 0 }
        c.global[dir][main][sub] = c.global[dir][main][sub] || 0
        c.global[dir].sum += amount
        c.global[dir][main].sum += amount
        c.global[dir][main][sub] += amount
      }
    }

    // #endregion

    // #region Helper Functions

    format_number = (val, space = true) => {
      if (val === '') return val
      val = parseFloat(val).toFixed(2).toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,')
      if (val.endsWith('.00')) val = val.slice(0, -3)
      if (val.includes('.')) {
        val = val.replace('.', ' .')
      } else if (space) {
        val += ' &puncsp;&numsp;&numsp;'
      }
      return val
    }

    sum_accounts = (date) => {
      date = moment(date)
      data.account_sums = data.account_sums || {}
      for (const acc of Object.values(data.accounts)) {
        data.account_sums[acc.name.id] = acc.init
      }

      for (const tx of data.transactions) {
        tx_date = moment(tx.date, data.format)
        if (tx_date.isSameOrBefore(date)) {
          if (['EX', 'TR'].includes(tx.type)) {
            data.account_sums[tx.from.account.id] -= tx.from.amount
          }
          if (['IN', 'TR'].includes(tx.type)) {
            data.account_sums[tx.to.account.id] += tx.to.amount
          }
        }
      }

      let total = 0
      for (const [key, val] of Object.entries(data.account_sums)) {
        $(`#account-sum-${key}`).html(format_number(val))
        const converted = exchange.calculate(
          val, data.accounts[key].currency || default_currency, display_currency
        )
        $(`#account-sum-${key}-converted`).html(format_number(converted))
        total += converted
      }

      $('#account-sum-total').html(format_number(total))
    }

    // #endregion

    $(async () => {

      // #region Categories

      // calculate average denominator
      const is_current = moment(data.transactions[0].date).year() == moment().year()
      let avg_denom = 12
      if (is_current) avg_denom *= moment().dayOfYear() / (moment().isLeapYear() ? 366 : 365)

      // calculate per-level stats for the cell colors
      const maxer = (base, key, val) => {
        base[key] = Math.max(base[key], val)
      }
      const cat_stats = {
        in: {
          month: { dir: 0, main: 0, sub: 0 },
          global: { dir: 0, main: 0, sub: 0 }
        },
        ex: {
          month: { dir: 0, main: 0, sub: 0 },
          global: { dir: 0, main: 0, sub: 0 }
        }
      }
      for (const [dir, dir_data] of Object.entries(data.category_sums.global)) {
        for (const [main, main_data] of Object.entries(dir_data)) {
          if (main == 'sum') {
            maxer(cat_stats[dir].global, 'dir', main_data)
          } else {
            for (const [sub, sub_data] of Object.entries(main_data)) {
              if (sub == 'sum') {
                maxer(cat_stats[dir].global, 'main', sub_data)
              } else {
                maxer(cat_stats[dir].global, 'sub', sub_data)
              }
            }
          }
        }
      }
      for (let month = 0; month < 12; ++month) {
        for (const [dir, dir_data] of Object.entries(data.category_sums.month[month])) {
          for (const [main, main_data] of Object.entries(dir_data)) {
            if (main == 'sum') {
              maxer(cat_stats[dir].month, 'dir', main_data)
            } else {
              for (const [sub, sub_data] of Object.entries(main_data)) {
                if (sub == 'sum') {
                  maxer(cat_stats[dir].month, 'main', sub_data)
                } else {
                  maxer(cat_stats[dir].month, 'sub', sub_data)
                }
              }
            }
          }
        }
      }
      
      // gets a single cell's value
      const get_cat_sum = (granularity, dir, main, sub) => {
        console.log('get_cat_sum', granularity, dir, main, sub)
        let target
        if (granularity == 'global') {
          target = data.category_sums.global[dir]
        } else {
          target = data.category_sums.month[granularity][dir]
        }
        if (!target) return 0
        if (main) {
          target = target[main]
          if (!target) return 0
          if (sub) {
            return target[sub] || 0
          } else {
            return target.sum || 0
          }
        } else {
          return target.sum || 0
        }
      }

      

      // gets a row's worth of values
      const get_cat_row = (dir, main, sub) => {
        console.log('get_cat_row', dir, main, sub)
        const months = []
        for (let month = 0; month < 12; ++month) {
          months.push(get_cat_sum(month, dir, main, sub))
          console.log('just calced', months[months.length - 1])
        }
        const sum = get_cat_sum('global', dir, main, sub)
        return {
          months,
          sum
        }
      }


      // format to thousands only
      const format_cat_number = (num) => {
        if (!num) return ''
        console.log('format_cat_number', num, '-->', format_number(Math.round(num / 1000), false))
        return format_number(Math.round(num / 1000), false)
      }

      const interpolate_color = (fraction, invert) => {
        return 'transparent'
      }


      const cat_table = $('#cat-table')
      const cat_tbody = cat_table.find('tbody')

      const build_cat_cell = (value, max, invert, filters) => {
        const color = interpolate_color(value / max, invert)
        const str = format_cat_number(value)
        let filter_arr = []
        for (const [key, val] of Object.entries(filters)) {
          filter_arr.push(`data-filter-${key}="${val}"`)
        }
        return `
          <td
            class="cat-cell right"
            ${filter_arr.join(' ')}
            style="background-color: ${color};"
          >
            ${str}
          </td>
        `
      }

      // direction level summaries (in vs. ex)
      const build_cat_dir = (dir) => {
        const invert = dir == 'ex'
        const row = get_cat_row(dir)
        const cells = ['<td colspan="2">Sum</td>']
        const month_stat = cat_stats[dir].month.dir
        const global_stat = cat_stats[dir].global.dir

        for (const [month, value] of row.months.entries()) {
          cells.push(build_cat_cell(value, month_stat, invert, {
            month,
            type: dir
          }))
        }

        cells.push(build_cat_cell(row.sum, global_stat, invert, {
          type: dir
        }))

        cells.push(build_cat_cell(row.sum / avg_denom, global_stat / avg_denom, invert, {
          type: dir
        }))

        cat_tbody.append($(`
          <tr>
            ${cells.join('')}
          </tr>
        `))
      }

      // main level summaries
      const build_cat_main = (dir, main) => {
        const invert = dir == 'ex'
        const row = get_cat_row(dir, main)
        const main_display = data.categories[main].name.display
        const cells = [`<td>${main_display}</td>`, '<td>Sum</td>']
        const month_stat = cat_stats[dir].month.main
        const global_stat = cat_stats[dir].global.main

        for (const [month, value] of row.months.entries()) {
          cells.push(build_cat_cell(value, month_stat, invert, {
            month,
            type: dir,
            main
          }))
        }

        cells.push(build_cat_cell(row.sum, global_stat, invert, {
          type: dir,
          main
        }))

        cells.push(build_cat_cell(row.sum / avg_denom, global_stat / avg_denom, invert, {
          type: dir,
          main
        }))

        cat_tbody.append($(`
          <tr>
            ${cells.join('')}
          </tr>
        `))
      }

      // sub level summaries
      const build_cat_sub = (dir, main, sub) => {
        const invert = dir == 'ex'
        const row = get_cat_row(dir, main, sub)
        const main_display = data.categories[main].name.display
        const sub_display = data.categories[main].subs[sub].display
        const cells = [`<td>${main_display}</td>`, `<td>${sub_display}</td>`]
        const month_stat = cat_stats[dir].month.sub
        const global_stat = cat_stats[dir].global.sub

        for (const [month, value] of row.months.entries()) {
          cells.push(build_cat_cell(value, month_stat, invert, {
            month,
            type: dir,
            main,
            sub
          }))
        }

        cells.push(build_cat_cell(row.sum, global_stat, invert, {
          type: dir,
          main,
          sub
        }))

        cells.push(build_cat_cell(row.sum / avg_denom, global_stat / avg_denom, invert, {
          type: dir,
          main,
          sub
        }))

        cat_tbody.append($(`
          <tr>
            ${cells.join('')}
          </tr>
        `))
      }

      const build_cat_half = (dir) => {
        const invert = dir == 'in'
        if (invert) build_cat_dir(dir)
        for (const main of Object.values(data.categories)) {
          console.log(main)
          if ((dir == 'in' && !main.incoming) || (dir == 'ex' && main.incoming)) continue
          if (invert) build_cat_main(dir, main.name.id)
          for (const sub of Object.values(main.subs)) {
            build_cat_sub(dir, main.name.id, sub.id)
          }
          if (!invert) build_cat_main(dir, main.name.id)
        }
        if (!invert) build_cat_dir(dir)
      }

      build_cat_half('in')
      build_cat_half('ex')

      
      

      // #endregion

      // #region Account Sums

      const acc_table = $('#acc-table')
      const acc_tbody = acc_table.find('tbody')
      // prep accounts by group
      const account_groups = {}
      const no_group_key = '&ndash;'
      for (const acc of Object.values(data.accounts)) {
        const key = acc.group || no_group_key
        account_groups[key] = account_groups[key] || []
        account_groups[key].push(acc)
      }
      for (const [group, accs] of Object.entries(account_groups)) {
        let first = true
        for (const acc of accs) {
          const group_str = first ? `
            <td rowspan="${accs.length}">${group}</td>
          ` : ''
          acc_tbody.append(`
            <tr>
              ${group_str}
              <td>${acc.name.display}</td>
              <td>${acc.currency || default_currency}</td>
              <td id="account-sum-${acc.name.id}" class="right"></td>
              <td id="account-sum-${acc.name.id}-converted" class="right"></td>
            </tr>
          `)
          first = false
        }
      }
      // init with full sums up to now
      sum_accounts(moment())
      // and then whenever the date selector changes
      $('#acc-date').on('change', function () {
        let date = $(this).val()
        if (date) {
          date = moment(date)
          if (!date.isValid()) {
            $(this).addClass('invalid')
            return
          } else {
            $(this).removeClass('invalid')
          }
        } else {
          date = moment()
        }
        sum_accounts(date)
      })

      // #endregion

      // #region Transactions

      const tx_table = $('#tx-table')
      const tx_tbody = tx_table.find('tbody')
      for (const tx of data.transactions) {
        const audited = (data.audit && moment(data.audit).isSameOrAfter(tx.date))
        tx_tbody.append(`
          <tr>
            <td class="center${audited ? ' audited' : ''}">${tx.date}</td>
            <td>${tx.mark}</td>
            <td>${tx.comment}</td>
            <td class="center type-${tx.type.toLowerCase()}">${tx.type}</td>
            <td class="right" data-converted="${tx.from.converted}">${tx.from.amount}</td>
            <td>${tx.from.account.display}</td>
            <td class="right" data-converted="${tx.to.converted}">${tx.to.amount}</td>
            <td>${tx.to.account.display}</td>
            <td>${tx.category.main.display}</td>
            <td>${tx.category.sub.display}</td>
          </tr>
        `)
      }

      const tx_pos = $('#tx-pos')
      const tx_sum_i = $('#tx-sum-i')
      const tx_sum_e = $('#tx-sum-e')
      const tx_sum_diff = $('#tx-sum-diff')
      const dt = tx_table.DataTable({
        order: [[0, "desc"]],
        autoWidth: false,
        lengthChange: false,
        pageLength: 25,
        dom: 'lrtip',
        columnDefs: [
          // correct number formats
          {
            render: (data, type, row, meta) => {
              return format_number(data)
            },
            targets: [4, 6]
          },
          // column width corrections
          {
            width: '25%',
            targets: 2
          },
          {
            width: '1px',
            targets: [1, 3]
          }
        ],
        // custom bottom info
        infoCallback: (settings, start, end, max, total, pre) => {
          const dt = new $.fn.dataTable.Api(settings)
          let expense = 0, incoming = 0
          dt.rows({ filter: 'applied' }).every(function () {
            const row = $(this.node()).children('td')
            if ($(row[3]).html() == 'TR') return
            expense += parseFloat($(row[4]).data('converted'))
            incoming += parseFloat($(row[6]).data('converted'))
          })

          const end_str = end != start ? `-${end}` : ''
          const max_str = max != total ? ` (${max})` : ''

          tx_pos.html(`${start}${end_str}/${total}${max_str}`)
          tx_sum_i.html(format_number(incoming, false))
          tx_sum_e.html(format_number(expense, false))
          tx_sum_diff.html(format_number(incoming - expense, false))
        }
      })

      // custom search for text stuff
      const cols = ['date', 'mark', 'comment', 'type', 'from-amt', 'from-acc', 'to-amt', 'to-acc', 'main', 'sub']
      for (const [index, col] of cols.entries()) {
        const dt_col = dt.column(index)
        const input = $(`<input type="text" id="search-${col}" />`).appendTo(dt_col.footer())
        if (col != 'date' && !col.endsWith('-amt')) {
          input.on('keyup', () => {
            // basic search at every keypress
            dt_col.search(input.val())
            dt.draw()
          })
        } else {
          // custom search is already there separately (see below)
          // so we just trigger a redraw
          input.on('change', () => {
            dt.draw()
          })
        }
      }

      // custom search for number ranges
      const num_or_default = (val, default_val) => {
        const res = parseFloat(val)
        if (Number.isNaN(res)) {
          return default_val
        }
        return res
      }

      const num_range_search = (id, index) => (settings, data, data_index) => {
        const term = $(id).val()
        if (!term) return true
        const val = parseFloat(data[index].toString().replace(',', ''))

        let min, max
        if (term.includes(':')) {
          [min, max] = term.split(':')
        } else {
          min = max = term
        }
        min = num_or_default(min, -Infinity)
        max = num_or_default(max, Infinity)

        return (min <= val && val <= max)
      }

      $.fn.dataTable.ext.search.push(num_range_search('#search-from-amt', 4))
      $.fn.dataTable.ext.search.push(num_range_search('#search-to-amt', 6))

      // custom search for dates
      const date_or_default = (date, default_date) => {
        const res = moment(date)
        if (!res.isValid()) {
          return default_date
        }
        return res
      }

      const date_range_search = (id, index) => (settings, data, data_index) => {
        const term = $(id).val()
        if (!term) return true
        const val = moment(data[index])

        let min, max
        if (term.includes(':')) {
          [min, max] = term.split(':')
        } else {
          min = max = term
        }
        min = date_or_default(min, moment('1970-01-01'))
        max = date_or_default(max, moment('3000-01-01'))

        return (min.isSameOrBefore(val) && val.isSameOrBefore(max))
      }

      $.fn.dataTable.ext.search.push(date_range_search('#search-date', 0))

      // #endregion

      // #region Keyboard shortcuts

      $('nav').focus()

      hotkeys('o', () => {
        $('#nav-overview-tab').click()
      })

      hotkeys('c', () => {
        $('#nav-categories-tab').click()
      })

      hotkeys('a', () => {
        $('#nav-accounts-tab').click()
        setTimeout(() => {
          $('#acc-date').focus()
        }, 1)
      })

      hotkeys('t', () => {
        $('#nav-transactions-tab').click()
        setTimeout(() => {
          $('#search-date').focus()
        }, 1)
      })

      // Esc to remove focus (so that I can use other hotkeys)
      window.onkeydown = function (e) {
        if (e.code === 'Escape') {
          const focused = document.activeElement;
          const elems = ['INPUT', 'TEXTAREA'];
          if (elems.includes(focused.tagName)) {
            focused.blur();
          }
        }
      }

      // #endregion

    })

  </script>
</body>

</html>