<!doctype html>
<html lang="en">
  
<!-- #region Boilerplate -->

<head>
  <meta charset="utf-8">
  <title>Coin View</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootswatch/4.4.1/darkly/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.10.20/css/dataTables.bootstrap4.min.css">

<!-- #endregion -->

<!-- #region CSS -->

  <style>
    nav {
      font-weight: bold;
      margin-top: 20px;
      margin-bottom: 20px;
    }

    nav .nav-link.active {
      background-color: #009670 !important;
    }

    .tab-pane {
      padding: 20px;
    }

    table.dataTable {
      width: 100%;
    }

    table.dataTable tr {
      line-height: 24px;
    }

    table.dataTable tbody tr.odd {
      background-color: #303030;
    }

    table.dataTable tbody tr:hover {
      background-color: #505050;
    }

    table.dataTable tbody td.type-in {
      background-color: #009670;
    }

    table.dataTable tbody td.type-tr {
      background-color: #D98D14;
    }

    table td.right, table th.right {
      text-align: right;
      padding-right: 10px;
    }

    table tbody td.center {
      text-align: center;
    }

    table.dataTable tfoot td input {
      width: 100%;
    }

    ul.pagination {
      float: right;
    }

    #tx-pos {
      float: left;
    }

    #tx-sum {
      text-align: center;
      font-size: large;
    }

    #tx-sum-diff {
      font-size: larger;
      font-weight: bold;
    }

    .tx-bottom-text {
      line-height: 34px;
    }

    #acc-table {
      width: auto;
      font-size: x-large;
      margin: 30px auto 0 auto;
    }

    #acc-table td, #acc-table th {
      padding: 0 30px;
    }
  </style>


</head>

<!-- #endregion -->

<!-- #region HTML -->

<body>

  <nav>
    <div class="nav nav-pills justify-content-center" id="nav-tab" role="tablist">
      <a class="nav-item nav-link active" id="nav-overview-tab" data-toggle="tab" href="#nav-overview" role="tab"
        aria-controls="nav-overview" aria-selected="true">Overview</a>
      <a class="nav-item nav-link" id="nav-categories-tab" data-toggle="tab" href="#nav-categories" role="tab"
        aria-controls="nav-categories" aria-selected="false">Categories</a>
      <a class="nav-item nav-link" id="nav-accounts-tab" data-toggle="tab" href="#nav-accounts" role="tab"
        aria-controls="nav-accounts" aria-selected="false">Accounts</a>
      <a class="nav-item nav-link" id="nav-transactions-tab" data-toggle="tab" href="#nav-transactions" role="tab"
        aria-controls="nav-transactions" aria-selected="false">Transactions</a>
    </div>
  </nav>

  <div class="tab-content" id="nav-tabContent">
    <div class="tab-pane active" id="nav-overview" role="tabpanel" aria-labelledby="nav-overview-tab">
      Overview
    </div>

    <div class="tab-pane" id="nav-categories" role="tabpanel" aria-labelledby="nav-categories-tab">
      Categories
    </div>

    <div class="tab-pane" id="nav-accounts" role="tabpanel" aria-labelledby="nav-accounts-tab">
      <table id="acc-table" class="table">
          <thead>
            <tr>
              <th>Account</th>
              <th>Currency</th>
              <th>Balance</th>
              <th>Converted</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <th>Sum:</th>
            <th></th>
            <th></th>
            <th id="account-sum-total" class="right"></th>
          </tfoot>
        </table>
    </div>

    <div class="tab-pane" id="nav-transactions" role="tabpanel" aria-labelledby="nav-transactions-tab">
      <table id="tx-table">
        <thead>
          <tr>
            <th class="date">Date</th>
            <th class="basic">Mark</th>
            <th class="basic">Comment</th>
            <th class="basic">Type</th>
            <th class="range">From Amount</th>
            <th class="basic">From Account</th>
            <th class="range">To Amount</th>
            <th class="basic">To Account</th>
            <th class="basic">Category</th>
            <th class="basic">Subcategory</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
        </tfoot>
      </table>
      <div id="tx-pos" class="tx-bottom-text"></div>
      <div id="tx-sum" class="tx-bottom-text">
        <span id="tx-sum-i"></span> -
        <span id="tx-sum-e"></span> =
        <span id="tx-sum-diff"></span>
      </div>
    </div>
  </div>

  <!-- #endregion -->

<!-- #region Script Includes -->

  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
    integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
    crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
    integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
    crossorigin="anonymous"></script>
  <script src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.10.20/js/dataTables.bootstrap4.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"
    integrity="sha256-4iQZ6BVL4qNKlQ27TExEhBN1HFPvAvAMbFavKKosSWQ=" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/hotkeys-js/dist/hotkeys.min.js"></script>

<!-- #endregion -->

  <script>
  
    // #region Currency Exchange

    data = INSERT_DATA_HERE
    default_currency = data.currency
    display_currency = data.display_currency || default_currency

    // const exchange = await (async () => {
    //   const base = display_currency
    //   const currs = new Set()
    //   for (const [, acc] of Object.entries(data.accounts)) {
    //     if (acc.currency) {
    //       currs.add(acc.currency)
    //     }
    //   }
    //   const symbols = [...currs].join(',')
    //   const api = `https://api.exchangeratesapi.io/latest?base=${base}&symbols=${symbols}`
    //   return await $.getJSON(api)
    // })()

    // use this actual response temporarily until development/testing is done
    exchange = {"rates":{"EUR":0.0030158634,"USD":0.0033400688,"GBP":0.0025392062},"base":"HUF","date":"2019-12-09"}
    exchange.calculate = (amount, from, to) => {
      if (from != exchange.base) {
        amount /= exchange.rates[from]
      }
      if (to != exchange.base) {
        amount *= exchange.rates[to]
      }
      return amount
    }

    // #endregion

    // #region Data Prep

    data.category_sums = {}
    for (const tx of data.transactions) {

      if (tx.from) {
        tx.from.converted = exchange.calculate(
          tx.from.amount,
          data.accounts[tx.from.account.id].currency || default_currency,
          display_currency
        )
        tx.from.str = tx.from.amount
      } else {
        tx.from = {converted: 0, amount: '', account: {display: ''}}
      }

      if (tx.to) {
        tx.to.converted = exchange.calculate(
          tx.to.amount,
          data.accounts[tx.to.account.id].currency || default_currency,
          display_currency
        )
        tx.to.str = tx.to.amount
      } else {
        tx.to = {converted: 0, amount: '', account: {display: ''}}
      }

      tx.category = tx.category || {main: {display: ''}, sub: {display: ''}}
    }

    // #endregion

    // #region Helper Functions

    format_number = (val) => {
      if (val === '') return val
      val = parseFloat(val).toFixed(2).toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,')
      if (val.endsWith('.00')) val = val.slice(0, -3)
      if (val.includes('.')) {
        val = val.replace('.', ' .')
      } else {
        val += ' &puncsp;&numsp;&numsp;'
      }
      return val
    }

    sum_accounts = (date) => {
      date = moment(date)
      data.account_sums = data.account_sums || {}
      for (const acc of Object.values(data.accounts)) {
        data.account_sums[acc.name.id] = acc.init
      }

      for (const tx of data.transactions) {
        tx_date = moment(tx.date, data.format)
        if (tx_date.isSameOrBefore(date)) {
          if (['EX', 'TR'].includes(tx.type)) {
            data.account_sums[tx.from.account.id] -= tx.from.amount
          }
          if (['IN', 'TR'].includes(tx.type)) {
            data.account_sums[tx.to.account.id] += tx.to.amount
          }
        }
      }

      let total = 0
      for (const [key, val] of Object.entries(data.account_sums)) {
        $(`#account-sum-${key}`).html(format_number(val))
        const converted = exchange.calculate(
          val, data.accounts[key].currency || default_currency, display_currency
        )
        $(`#account-sum-${key}-converted`).html(format_number(converted))
        total += converted
      }

      $('#account-sum-total').html(format_number(total))
    }

    // #endregion

    $(async () => {

      // #region Account Sums

      const acc_table = $('#acc-table')
      const acc_tbody = acc_table.find('tbody')
      for (const acc of Object.values(data.accounts)) {
        acc_tbody.append(`
          <tr>
            <td>${acc.name.display}</td>
            <td>${acc.currency || default_currency}</td>
            <td id="account-sum-${acc.name.id}" class="right"></td>
            <td id="account-sum-${acc.name.id}-converted" class="right"></td>
          </tr>
        `)
      }
      // init with full sums up to now
      sum_accounts(moment())

      // #endregion

      // #region Transactions

      const tx_table = $('#tx-table')
      const tx_tbody = tx_table.find('tbody')
      for (const tx of data.transactions) {
        tx_tbody.append(`
          <tr>
            <td>${tx.date}</td>
            <td>${tx.mark}</td>
            <td>${tx.comment}</td>
            <td class="center type-${tx.type.toLowerCase()}">${tx.type}</td>
            <td class="right" data-converted="${tx.from.converted}">${tx.from.amount}</td>
            <td>${tx.from.account.display}</td>
            <td class="right" data-converted="${tx.to.converted}">${tx.to.amount}</td>
            <td>${tx.to.account.display}</td>
            <td>${tx.category.main.display}</td>
            <td>${tx.category.sub.display}</td>
          </tr>
        `)
      }

      const tx_pos = $('#tx-pos')
      const tx_sum_i = $('#tx-sum-i')
      const tx_sum_e = $('#tx-sum-e')
      const tx_sum_diff = $('#tx-sum-diff')
      const dt = tx_table.DataTable({
        order: [[0, "desc"]],
        autoWidth: false,
        lengthChange: false,
        pageLength: 25,
        dom: 'lrtip',
        columnDefs: [
          // correct number formats
          {
            render: (data, type, row, meta) => {
              return format_number(data)
            },
            targets: [4, 6]
          },
          // column width corrections
          {
            width: '25%',
            targets: 2
          },
          {
            width: '1px',
            targets: [1, 3]
          }
        ],
        // custom bottom info
        infoCallback: (settings, start, end, max, total, pre) => {
          const dt = new $.fn.dataTable.Api(settings)
          let expense = 0, incoming = 0
          dt.rows({filter: 'applied'}).every(function () {
            const row = $(this.node()).children('td')
            expense += parseFloat($(row[4]).data('converted'))
            incoming += parseFloat($(row[6]).data('converted'))
          })

          const end_str = end != start ? `-${end}` : ''
          const max_str = max != total ? ` (${max})` : ''

          tx_pos.html(`${start}${end_str}/${total}${max_str}`)
          tx_sum_i.html(format_number(incoming))
          tx_sum_e.html(format_number(expense))
          tx_sum_diff.html(format_number(incoming - expense))
        }
      })

      // custom search for text stuff
      const cols = ['date', 'mark', 'comment', 'type', 'from-amt', 'from-acc', 'to-amt', 'to-acc', 'main', 'sub']
      for (const [index, col] of cols.entries()) {
        const dt_col = dt.column(index)
        const input = $(`<input type="text" id="search-${col}" />`).appendTo(dt_col.footer())
        if (col != 'date' && !col.endsWith('-amt')) {
          input.on('keyup', () => {
            // basic search at every keypress
            dt_col.search(input.val())
            dt.draw()
          })
        } else {
          // custom search is already there separately (see below)
          // so we just trigger a redraw
          input.on('change', () => {
            dt.draw()
          })
        }
      }

      // custom search for number ranges
      const num_or_default = (val, default_val) => {
        const res = parseFloat(val)
        if (Number.isNaN(res)) {
          return default_val
        }
        return res
      }

      const num_range_search = (id, index) => (settings, data, data_index) => {
        const term = $(id).val()
        if (!term) return true
        const val = parseFloat(data[index].toString().replace(',', ''))

        let min, max
        if (term.includes(':')) {
          [min, max] = term.split(':')
        } else {
          min = max = term
        }
        min = num_or_default(min, -Infinity)
        max = num_or_default(max, Infinity)

        return (min <= val && val <= max)
      }

      $.fn.dataTable.ext.search.push(num_range_search('#search-from-amt', 4))
      $.fn.dataTable.ext.search.push(num_range_search('#search-to-amt', 6))

      // custom search for dates
      const date_or_default = (date, default_date) => {
        const res = moment(date)
        if (!res.isValid()) {
          return default_date
        }
        return res
      }

      const date_range_search = (id, index) => (settings, data, data_index) => {
        const term = $(id).val()
        if (!term) return true
        const val = moment(data[index])

        let min, max
        if (term.includes(':')) {
          [min, max] = term.split(':')
        } else {
          min = max = term
        }
        min = date_or_default(min, moment('1970-01-01'))
        max = date_or_default(max, moment('3000-01-01'))

        return (min.isSameOrBefore(val) && val.isSameOrBefore(max))
      }

      $.fn.dataTable.ext.search.push(date_range_search('#search-date', 0))

      // #endregion

      // #region Keyboard shortcuts

      $('nav').focus()

      hotkeys('o', () => {
        $('#nav-overview-tab').click()
      })

      hotkeys('c', () => {
        $('#nav-categories-tab').click()
      })

      hotkeys('a', () => {
        $('#nav-accounts-tab').click()
      })

      hotkeys('t', () => {
        $('#nav-transactions-tab').click()
        setTimeout(() => {
          $('#search-date').focus()
        }, 1)
      })

      // #endregion

    })

  </script>
</body>
</html>